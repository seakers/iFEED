<!DOCTYPE html>
<!--
To change this license header, choose License Headers in Project Properties.
To change this template file, choose Tools | Templates
and open the template in the editor.
-->
<html>
    <head>
        <title>Feature Application Status</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">

        <script src="js/lib/jquery.js" type="text/javascript"></script>
        <script src="js/lib/d3.js"></script>
	   
	<style>


        #title{
            margin-bottom: 18px;
            margin-left: 3px;
            font-size: 18px;
        }
        
        #application_status{
            width:850px;
            padding:20px;
            background-color: #E0E0E0; 
            float:left;
        }
        
        .application_options_button{
            margin-left: 10px;
            float:left;
        }

        .applied_feature{
            width:100%;
            margin-bottom: 4px;
            float:left;
        }

        .feature_application_delete{
            background-color: #FF5151;
            float:left;
        }
        .feature_application_activate {
            float:left;
            margin-right:4px;
        }
        .feature_application_logical_connective {
            float: left;
            margin-right:4px;
        }
        .feature_application_expression{
            float: left;
            margin-right:4px;
        }


        body {
            font: sans-serif;
        }

        
        .img-hor-vert {
            -moz-transform: scale(-1, -1);
            -o-transform: scale(-1, -1);
            -webkit-transform: scale(-1, -1);
            transform: scale(-1, -1);
        }

	</style>


    </head>
    <body>
<!--
    #application_status (div)
        #applied_feature_div
            #applied_feature_1 .applied_feature (div)
                .feature_application_activate
                .feature_application_logical_connective
                .feature_application_expression
                .feature_application_delete
-->
        
        
        <div id='title_div' style='width:100%; margin-top:20px; margin-bottom:20px;'>
            <h2 id='title', style='margin:auto;font-size:18px'>Feature Application Status</h2>
        </div>
        
        <div id='options_panel_div' style='width:100%; float:left; margin-top:10px; margin-bottom:20px;'>
            <div id='options_panel' style='margin-left: 10px;'>
                <button id='toggle_feature_scheme' class='application_options_button'>
                    Deactivate all features
                </button>
          
                <button id='test_feature_scheme' class='application_options_button'>
                    Test current feature
                </button>
                
                

            </div>
        </div>
        
        <div id='application_status'>
            <div id='applied_feature_div'></div>
        </div>
        
        
        
        <script src="js/relabel.js" type="text/javascript"></script>
        <script>

            
var key = window.location.search;
key = key.substring(1);            

            

var features_activation_store = [];
var featureID = 0;    
      
            

            
            
function add_temp_feature(inputExpression){
    

    if(inputExpression!=''){
        var temp_feature = d3.select('[status=temp]')
                                .attr('status','added');
        temp_feature.select('.feature_application_expression')
                .attr('expression',inputExpression)
                .text(pp_feature(inputExpression))
                .style("color","#000000");
    }
    

    if(d3.select('[status=temp]')[0][0]){
        return;
    }


    var applied_features = d3.select('#applied_feature_div');
    var id = featureID++;
    var this_feature = applied_features.append('div')
            .attr('id',function(){
                return 'applied_feature_' + id;
            })
            .attr('class','applied_feature')
            .attr('status','temp');

    this_feature.append('input')
            .attr('type','checkbox')
            .attr('class','feature_application_activate');
    this_feature.append('select')
            .attr('class','feature_application_logical_connective')
            .selectAll('option')
            .data([{value:"&&",text:"AND"},{value:"||",text:"OR"}])
            .enter()
            .append("option")
            .attr("value",function(d){
                return d.value;
            })
            .text(function(d){
                return d.text;
            });
    this_feature.append('div')
            .attr('class','feature_application_expression')
            .attr('expression',function(d){
                return '{tempFeature}';
            })
            .text('New driving feature to be added')
            .style("color","#989898");

    this_feature.append('img')
            .attr('src','img/left_arrow.png')
            .attr('id',function(){
                return 'leftarrow_' + id;
            })
            .attr('width','20')
            .attr('height','20')
            .style('float','left')
            .style('margin-left','13px')
            .on("click",function(d){
               click_left_arrow(id);
            });;
    this_feature.append('img')
            .attr('src','img/left_arrow.png')
            .attr('id',function(){
                return 'rightarrow_' + id;
            })
            .attr('class','img-hor-vert')
            .attr('width','20')
            .attr('height','20')
            .style('float','left')
            .style('margin-left','4px')
            .style('margin-right','7px')
            .on("click",function(d){
               click_right_arrow(id);
            });

    this_feature.append('button')
            .attr('class','feature_application_delete')
            .text('Remove');
    this_feature.select('.feature_application_activate')[0][0].checked=true;
    this_feature.select('.feature_application_logical_connective')[0][0].value="&&";


    this_feature.select(".feature_application_delete").on("click",function(d){
        var activated = this_feature.select('.feature_application_activate')[0][0].checked;
        this_feature.remove();

        if(activated){
            apply_current_feature_scheme('apply');
        }
    });


    this_feature.select('.feature_application_activate').on("change",function(d){

        var id = this_feature.attr('id');
        var n = id.substring(id.length-1);
        if(n < features_activation_store.length){
            reset_feature_activation();
        }

        var activated = this_feature.select('.feature_application_activate')[0][0].checked;
        this_feature.select('.feature_application_expression').style("color",function(d){
            if(activated){
                return "#000000"; //black
            }else{
                return "#989898"; // gray
            }
        });
        apply_current_feature_scheme('apply');
    });


    this_feature.select('.feature_application_logical_connective').on("change",function(d){
        apply_current_feature_scheme('apply');
    });


    d3.select('#save_current_feature_scheme')
            .on('click',function(d){
                save_current_feature_scheme();
            });  


}
                                                

function add_feature(inputExpression,option){    
    
    var applied_features = d3.select('#applied_feature_div');
    var id = featureID++;
    
    var this_feature = applied_features.append('div')
            .attr('id',function(){
                return 'applied_feature_' + id;
            })
            .attr('class','applied_feature');
    
    this_feature.append('input')
            .attr('type','checkbox')
            .attr('class','feature_application_activate');
    this_feature.append('select')
            .attr('class','feature_application_logical_connective')
            .selectAll('option')
            .data([{value:"&&",text:"AND"},{value:"||",text:"OR"}])
            .enter()
            .append("option")
            .attr("value",function(d){
                return d.value;
            })
            .text(function(d){
                return d.text;
            });
    this_feature.append('div')
            .attr('class','feature_application_expression')
            .attr('expression',function(d){
            	return inputExpression;
            })
            .text(pp_feature(inputExpression));
    
    this_feature.append('img')
            .attr('src','img/left_arrow.png')
            .attr('id',function(){
                return 'leftarrow_' + id;
            })
            .attr('width','20')
            .attr('height','20')
            .style('float','left')
            .style('margin-left','13px')
            .on("click",function(d){
    	       click_left_arrow(id);
            });;
    this_feature.append('img')
            .attr('src','img/left_arrow.png')
            .attr('id',function(){
                return 'rightarrow_' + id;
            })
            .attr('class','img-hor-vert')
            .attr('width','20')
            .attr('height','20')
            .style('float','left')
            .style('margin-left','4px')
            .style('margin-right','7px')
            .on("click",function(d){
               click_right_arrow(id);
            });
    
    this_feature.append('button')
            .attr('class','feature_application_delete')
            .text('Remove');
    
    
    if(option==="new"){
        // Activate only the current filter
        d3.selectAll('.feature_application_activate')[0].forEach(function(d){
            d3.select(d)[0][0].checked=false;
        })        
        d3.selectAll('.feature_application_expression').style("color","#989898"); // gray
        this_feature.select('.feature_application_expression').style("color","#000000"); // black
        this_feature.select('.feature_application_activate')[0][0].checked=true;
        this_feature.select('.feature_application_logical_connective')[0][0].value="&&";
    }else if(option==="add"){ // or
        this_feature.select('.feature_application_activate')[0][0].checked=true;
        this_feature.select('.feature_application_logical_connective')[0][0].value="||";
    }else if(option==="within"){ // and
        this_feature.select('.feature_application_activate')[0][0].checked=true;
        this_feature.select('.feature_application_logical_connective')[0][0].value="&&";
    }else if(option==="deactivated"){
        this_feature.select('.feature_application_activate')[0][0].checked=false;
        this_feature.select('.feature_application_logical_connective')[0][0].value="&&";
        this_feature.select('.feature_application_expression').style("color","#989898"); // gray        
    }
    
    
    this_feature.select(".feature_application_delete").on("click",function(d){
        var activated = this_feature.select('.feature_application_activate')[0][0].checked;
        this_feature.remove();
        
        if(activated){
            apply_current_feature_scheme('apply');
        }
    });
    

    this_feature.select('.feature_application_activate').on("change",function(d){
        
        var id = this_feature.attr('id');
        var n = id.substring(id.length-1);
        if(n < features_activation_store.length){
            reset_feature_activation();
        }
        
        var activated = this_feature.select('.feature_application_activate')[0][0].checked;
        this_feature.select('.feature_application_expression').style("color",function(d){
            if(activated){
                return "#000000"; //black
            }else{
                return "#989898"; // gray
            }
        });
        apply_current_feature_scheme('apply');
    });
    
    
    this_feature.select('.feature_application_logical_connective').on("change",function(d){
        apply_current_feature_scheme('apply');
    });

    
    d3.select('#save_current_feature_scheme')
            .on('click',function(d){
                save_current_feature_scheme();
            });        
}
            
            
            
function remove_feature(expression){
    
    var applied_features = d3.select('#applied_feature_div');
    applied_features.selectAll('.applied_feature')[0].forEach(function(d){
        var this_feature = d3.select(d);
        if(this_feature.select('.feature_application_expression').attr('expression')==expression){
            this_feature.remove();
        }
    });

    apply_current_feature_scheme('update');
}
            
            

var arrow_margin = 30;
function click_right_arrow(n){
	var id = "" + n;
	var appliedFilter = d3.select("#applied_feature_"+id);
	if(appliedFilter.attr('level')==null){
		appliedFilter.attr('level',1);
	}
	else{
		var level = +appliedFilter.attr('level');
		appliedFilter.attr('level',function(){
			return level+1;
		});
	}
	var level = +appliedFilter.attr('level');
	
	appliedFilter.select('.feature_application_activate').style('margin-right',function(){
		var margin = level*arrow_margin
		return level*arrow_margin+"px";
	});
	apply_current_feature_scheme('apply');
}
            
            
function click_left_arrow(n){
	var id = "" + n;
	var appliedFilter = d3.select("#applied_feature_"+id);
	if(appliedFilter.attr('level')==null){
		appliedFilter.attr('level',0);
	}else if(appliedFilter.attr('level')==0){
		// do nothing
	}else{
		var level = +appliedFilter.attr('level');
		appliedFilter.attr('level',function(){
			return level-1;
		});
	}
	var level = +appliedFilter.attr('level');
	appliedFilter.select('.feature_application_activate').style('margin-right',function(){
		var margin = level*arrow_margin
		return level*arrow_margin+"px";
	});
	apply_current_feature_scheme('apply');
}
            
            
            

       
function parse_feature_application_status(){
	
    var application_status = d3.select('#applied_feature_div');
    var count = application_status.selectAll('.applied_feature').size();
    var filter_expressions = [];
    var filter_logical_connective = [];
    var filter_level = [];
    
    application_status.selectAll('.applied_feature')[0].forEach(function(d){
    	
        var activated = d3.select(d).select('.feature_application_activate')[0][0].checked;
        var expression = d3.select(d).select('.feature_application_expression').attr('expression');
        var logic = d3.select(d).select('.feature_application_logical_connective')[0][0].value;
        var level = d3.select(d).attr('level');
        

        if(activated){
        	if(expression.indexOf('&&')!=-1 || expression.indexOf('||')!=-1){
        		expression = '('+expression+')';
        	}
            filter_expressions.push(expression);
            filter_logical_connective.push(logic);
        	if(level==null){
        		filter_level.push(0);
        	}else{
        		var levelNum = + level;
        		filter_level.push(levelNum);
        	}
        }
    });

    
    
    var filterExpression = "";
    var prev_level = 0;
    for(var i=0;i<filter_expressions.length;i++){
    	var level = filter_level[i];
        if(i > 0){
            if(level > prev_level){
            	filterExpression = filterExpression + filter_logical_connective[i];
            	while(prev_level != level){
            		filterExpression = filterExpression + "(";
            		prev_level++;
            	}
            }else if(level < prev_level){
            	while(prev_level > level){
            		filterExpression = filterExpression + ")";
            		prev_level--;
            	}
            	filterExpression = filterExpression + filter_logical_connective[i];
            }else{
            	filterExpression = filterExpression + filter_logical_connective[i];
            }
        }else if(i==0){ // i=0
            if(level > 0){
            	while(prev_level < level){
	            	filterExpression = filterExpression + "(";
	            	prev_level++;
            	}
        	}
        }
        filterExpression = filterExpression + filter_expressions[i];
    }

    if(prev_level>0){
    	while(prev_level!=0){
        	filterExpression = filterExpression + ")";
        	prev_level--;
    	}
    }
    
    console.log(filterExpression);
    return filterExpression;
}     
            
            
            
            
function apply_current_feature_scheme(option){

    var expression = parse_feature_application_status();
   
    var data = {
        key:key,
        source:'feature_application_status',
        expression:expression,
        option:option
    }

    $.ajax({
        url: "/api/ifeed/apply-feature-expression/",
        type: "POST",
        data: data,
        async: false,
        error: function (jqXHR, textStatus, errorThrown){
            alert("Error in applying the current filter scheme");
        }
    });
    return;
}
            
            
      
function getOrbitList() {
    var orbitList;
    $.ajax({
        url: "/api/vassar/get-orbit-list/",
        type: "POST",
        async: false,
        success: function (data, textStatus, jqXHR)
        {
            orbitList = data;
        },
        error: function (jqXHR, textStatus, errorThrown)
        {
            alert("error");
        }
    });
    return orbitList;
}
            
            
function getInstrumentList() {
    var instrumentList;
    $.ajax({
        url: "/api/vassar/get-instrument-list/",
        type: "POST",
        async: false,
        success: function (data, textStatus, jqXHR)
        {
            instrumentList = data;
        },
        error: function (jqXHR, textStatus, errorThrown)
        {
            alert("error");
        }
    });
    return instrumentList;
}
           
            
function test_feature(){
    	
    var application_status = d3.select('#applied_feature_div');
    var count = application_status.selectAll('.applied_feature').size();
    var status = d3.select('.applied_feature').attr('status');
    
    if(count==0){
        return;
    }else if(count==1 && status=='temp'){
        return;
    }else{
        apply_current_feature_scheme('test');
    }
}

function toggle_feature_activation(){

    if(features_activation_store.length==0){
        d3.selectAll('.applied_feature')[0].forEach(function(d){
            var activated = d3.select(d).select('.feature_application_activate')[0][0].checked;
            features_activation_store.push(activated);
            
            if(activated){
                d3.select(d).select('.feature_application_activate')[0][0].checked = false;
                d3.select(d).select('.feature_application_expression').style('color',"#989898");
            }
        });
        d3.select('#toggle_feature_scheme').text('Restore all features');
    }else{
        d3.selectAll('.applied_feature')[0].forEach(function(d,i){
            if(i < features_activation_store.length){
                d3.select(d).select('.feature_application_activate')[0][0].checked = features_activation_store[i];
                if(features_activation_store[i]){
                    d3.select(d).select('.feature_application_expression').style('color',"#000000");
                }
            }
        });
        reset_feature_activation();
    }
    apply_current_feature_scheme('apply');
}

            
function reset_feature_activation(){
    d3.select('#toggle_feature_scheme').text('Deactivate all features');
    features_activation_store = [];
}         

            
            
var socket = new WebSocket("ws://127.0.0.1:8001/ifeed/"+key);
socket.onmessage = function(e){
    
    var text = e.data;
    var data = JSON.parse(text);
    
    // If the target is not feature application status page, return.
    if(data.target!='ifeed.feature_application_status') return;
    
    if(data.id=='request'){
        apply_current_feature_scheme('update');
        return;
    }else if(data.id=='update'){
        var expression = data.expression;
        var option = data.option;
        if(option=='remove'){
            remove_feature(expression);
            apply_current_feature_scheme('apply');
        }else if(option=='temp'){
            add_temp_feature(expression);
        }else{ // {'new','add','within'}
            add_feature(expression,option); 
        }
    }
};   
            

var orbitList = getOrbitList();
var instrList = getInstrumentList(); 
var norb = orbitList.length;
var ninstr = instrList.length;

            
d3.select('#toggle_feature_scheme').on('click',toggle_feature_activation);
d3.select('#test_feature_scheme').on('click',test_feature);     
            
        </script>
    </body>
</html>





    
    
    